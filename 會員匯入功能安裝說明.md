# 會員匯入功能安裝說明

## 一、安裝 PhpSpreadsheet 套件

在專案根目錄執行以下命令安裝 PhpSpreadsheet：

```bash
composer require phpoffice/phpspreadsheet
```

或者使用 composer update：

```bash
composer update
```

## 二、功能說明

### 1. 匯入入口
- 後台路徑：`/member/import`
- 從會員列表頁面點擊「匯入會員」按鈕進入

### 2. Excel 格式要求

**欄位順序（共 13 欄）：**
1. ID(四位數0001) - 會員編號（選填，留空系統自動生成）
2. 區 - 區域名稱（如：信義區、中正區）
3. 帳號(Email) - **必填**，作為會員登入帳號
4. 密碼 - 會員密碼
5. 名稱(姓名) - **必填**
6. 手機 - 手機號碼
7. 生日 - 日期格式（YYYY/MM/DD 或 YYYY-MM-DD）
8. 所在城市 - 城市名稱
9. 所在區域 - 區域名稱
10. 所在地址 - 詳細地址
11. 其他城市 - 其他城市資訊
12. 會員期限起 - 期間開始日期
13. 會員期限訖 - 期間結束日期

**範例資料：**
```
ID          區      帳號(Email)           密碼    名稱    手機        生日        所在城市  所在區域  所在地址  其他城市  會員期限起  會員期限訖
00001       信義區  test1@example.com    123456  Mingo1  0912345678  1981/11/7   台北市    信義區    AA路      新竹      2025/7/1    2026/6/30
00002       中正區  test2@example.com    123456  Mingo2  0912345679  1988/11/1   新北市    板橋區    BB路                2025/9/1    2026/8/30
```

### 3. 特殊處理規則

#### (1) 城市名稱自動轉換
- 「臺北市」→「台北市」
- 「臺南市」→「台南市」
- 所有「臺」字自動轉換為「台」字

#### (2) 區域名稱自動補全
- 如果區域名稱沒有「區」字，系統會自動補上
- 例如：「信義」→「信義區」

#### (3) Email 重複處理
- 如果 Email 已存在，則**更新**該會員資料
- 如果 Email 不存在，則**新增**會員

#### (4) 會員編號處理
- 如果 Excel 提供會員編號，則使用 Excel 的編號
- 如果 Excel 未提供會員編號，系統自動生成（00001~99999）

#### (5) 新增會員預設值
- 狀態：上線
- 驗證狀態：已認證
- 國家：台灣
- 角色：一般會員

### 4. 匯入流程

1. **選擇檔案**：點擊「選擇 Excel 檔案」，選擇要匯入的 .xlsx 或 .xls 檔案
2. **開始匯入**：點擊「開始匯入」按鈕
3. **系統處理**：系統自動解析 Excel 並處理每一筆資料
4. **顯示結果**：
   - 成功筆數
   - 失敗筆數
   - 失敗記錄明細（包含錯誤原因）

### 5. 區域驗證

**重要：Excel 中的「區」欄位必須已存在於系統的區域管理中**

- 匯入前請先到「區域管理」(`/area/index`) 確認所需區域是否已建立
- 如果 Excel 中的區域名稱在系統中不存在，該筆資料將匯入失敗
- 失敗原因會顯示：「區域『XXX』不存在，請先在系統中建立該區域」
- 建議先建立所有需要的區域，再執行會員匯入

**範例：**
- ✅ 正確：Excel 填寫「信義區」，系統區域管理中有「信義區」→ 匯入成功
- ❌ 錯誤：Excel 填寫「大安區」，系統區域管理中沒有「大安區」→ 匯入失敗

### 6. 下載範例檔案

點擊「下載範例檔案」按鈕可下載包含範例資料的 Excel 檔案，方便快速了解格式要求。

## 三、錯誤處理

### 常見錯誤訊息

1. **「Email 不能為空」**
   - 原因：Email 欄位為必填
   - 解決：確保每一行都有填寫 Email

2. **「姓名不能為空」**
   - 原因：姓名欄位為必填
   - 解決：確保每一行都有填寫姓名

3. **「區域『XXX』不存在，請先在系統中建立該區域」**
   - 原因：Excel 中填寫的區域名稱在系統中找不到
   - 解決：
     - 方法1：先到「區域管理」建立該區域，再重新匯入
     - 方法2：修改 Excel，使用系統已存在的區域名稱
     - 方法3：如果不需要區域資訊，可以將該欄位留空

4. **「檔案解析失敗」**
   - 原因：檔案格式不正確或檔案損壞
   - 解決：確保使用正確的 Excel 格式（.xlsx 或 .xls）

5. **驗證錯誤**
   - 原因：資料不符合驗證規則（如 Email 格式錯誤）
   - 解決：檢查失敗記錄明細，修正資料後重新匯入

## 四、注意事項

1. **第一行必須是標題行**，資料從第二行開始
2. **備份資料**：匯入前建議先備份現有資料
3. **測試匯入**：建議先用少量資料測試匯入功能
4. **Email 唯一性**：同一個 Email 只能對應一個會員
5. **日期格式**：建議使用 YYYY/MM/DD 或 YYYY-MM-DD 格式
6. **區域驗證**：⚠️ **區域名稱必須已存在於系統的「區域管理」中，否則匯入將失敗**
7. **區域匹配**：區域名稱必須與系統中的區域名稱完全一致（包含大小寫）
8. **匯入順序建議**：
   - 第一步：確認或建立所需的區域（`/area/index`）
   - 第二步：準備會員 Excel 資料
   - 第三步：執行會員匯入

## 五、技術細節

### 相關檔案
- Controller：`backend/controllers/MemberController.php`
- View：`backend/views/member/import.php`
- Model：`common/models/MemberModel.php`

### 匯入 Scenario
- 使用 `MemberModel::SCENARIO_IMPORT`
- 自動處理新增/更新邏輯
- 自動生成 username（使用 Email）
- 新增會員時自動生成 member_code（如果未提供）

### 日期處理
- 支援 Excel 數字日期格式
- 支援字串日期格式（YYYY-MM-DD、YYYY/MM/DD）
- 自動轉換為資料庫日期格式（YYYY-MM-DD）

## 六、測試建議

### 測試步驟
1. 下載範例檔案
2. 修改範例資料（使用實際的測試資料）
3. 執行匯入
4. 檢查匯入結果
5. 確認會員資料正確顯示在列表中

### 測試場景
- ✅ 匯入全新會員
- ✅ 匯入已存在的會員（更新資料）
- ✅ 匯入包含臺字的城市名稱
- ✅ 匯入沒有「區」字的區域名稱
- ✅ 匯入不完整的資料（測試驗證規則）
- ✅ 匯入大量資料（測試效能）

