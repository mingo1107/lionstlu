# 測試步驟 - 診斷「登入兩次」問題

## 請按照以下步驟操作並告訴我結果：

### 步驟 1：清除環境
```
1. 清除瀏覽器所有 Cookie
2. 關閉所有瀏覽器分頁
3. 開啟無痕視窗
```

### 步驟 2：第一次登入
```
1. 訪問 /member/login
2. 輸入帳號密碼
3. 點擊「登入」
4. 觀察首頁是否顯示已登入
```

**第一次登入後的狀態：**
- [ ] 已登入（顯示會員資訊）
- [ ] 未登入（isGuest=true）

### 步驟 3：立即訪問診斷頁面

**第一次登入後立即訪問：**
```
http://your-domain.com/check-login.php
```

請截圖或複製以下資訊：

#### A. 基本登入狀態
- isGuest: ?
- User ID: ?
- Identity: ?

#### B. AuthKey Cookie 檢查
- Cookie 是否存在: ?
- 解密後的 AuthKey: ?

#### C. AuthKey 解析（如果有）
- 分割結果幾個部分: ?
- 使用的分隔符: ?

#### D. 驗證條件檢查
- [ ] Timestamp 有效
- [ ] User ID 匹配
- [ ] User Agent 匹配
- [ ] 所有條件通過？

---

### 步驟 4：第二次登入（如果第一次失敗）

如果第一次登入後 isGuest=true：

```
1. 再次訪問 /member/login
2. 再次輸入帳號密碼並登入
3. 觀察首頁是否顯示已登入
```

**第二次登入後的狀態：**
- [ ] 已登入
- [ ] 仍未登入

---

## 我需要知道的關鍵資訊：

### 問題 1：Cookie 是否被設置？
第一次登入後，`check-login.php` 中：
- 「3. AuthKey Cookie 檢查」→「Cookie 是否存在」
- 答案是：✅ Yes 還是 ❌ No？

### 問題 2：AuthKey 格式是否正確？
第一次登入後，`check-login.php` 中：
- 「4. AuthKey 格式錯誤」是否出現？
- 或「4. AuthKey 解析」顯示幾個部分？
- 應該是 4 個部分才對

### 問題 3：哪個驗證條件失敗了？
第一次登入後，`check-login.php` 中：
- 「5. 驗證條件檢查」中哪一項是 ❌？

---

## 可能的情況

### 情況 A：Cookie 沒有被設置
如果「Cookie 是否存在」= ❌ No

**原因：** Cookie 寫入時機問題

### 情況 B：AuthKey 格式錯誤
如果分割結果不是 4 個部分

**原因：** 分隔符問題沒解決

### 情況 C：某個驗證條件失敗
如果 Cookie 存在且格式正確，但某個驗證失敗

**原因：** 驗證邏輯問題

---

請提供 `check-login.php` 的結果，我才能準確診斷問題！

