# 資料庫連線問題排查 - Laradock

## 錯誤訊息
```
SQLSTATE[HY000] [2002] Connection refused
```

## 問題原因
在 Laradock 環境中，PHP 應用運行在容器內，需要使用**容器名稱**來連線資料庫，而不是 `127.0.0.1` 或 `localhost`。

## 解決方案

### 1. 檢查 MySQL 容器是否運行
```bash
cd ../laradock
docker-compose ps mysql
```

如果沒有運行，啟動 MySQL：
```bash
docker-compose up -d mysql
```

### 2. 確認 MySQL 容器名稱
```bash
docker-compose ps | grep mysql
```

常見的容器名稱：
- `mysql`（預設）
- `mariadb`（如果使用 MariaDB）
- `percona`（如果使用 Percona）

### 3. 修改資料庫配置

在 Laradock 環境中，應該使用容器名稱：

**錯誤配置：**
```php
'dsn' => 'mysql:host=127.0.0.1;dbname=ball_lionstlu',
// 或
'dsn' => 'mysql:host=localhost;dbname=ball_lionstlu',
```

**正確配置（Laradock）：**
```php
'dsn' => 'mysql:host=mysql;dbname=ball_lionstlu',
```

### 4. 檢查 MySQL 連線設定

確認以下設定：
- **主機名稱**：`mysql`（容器名稱）
- **資料庫名稱**：`ball_lionstlu`
- **使用者名稱**：`ball`
- **密碼**：`usERwinDT@lk`
- **Port**：預設 3306（通常不需要指定）

### 5. 測試資料庫連線

在 PHP 容器內測試連線：
```bash
cd ../laradock
docker-compose exec php-fpm bash

# 在容器內執行
mysql -h mysql -u ball -p
# 輸入密碼：usERwinDT@lk
```

或使用 PHP 測試：
```bash
docker-compose exec php-fpm php -r "try { \$pdo = new PDO('mysql:host=mysql;dbname=ball_lionstlu', 'ball', 'usERwinDT@lk'); echo '連線成功！'; } catch (Exception \$e) { echo '連線失敗：' . \$e->getMessage(); }"
```

## 常見問題

### Q: 為什麼不能用 127.0.0.1？
A: 在 Docker 容器環境中，`127.0.0.1` 指向容器本身，而不是其他容器。需要使用容器名稱或 Docker 網路中的 IP。

### Q: 如何確認容器名稱？
A: 執行 `docker-compose ps` 查看所有容器名稱，或查看 `docker-compose.yml` 檔案中的服務名稱。

### Q: 如果容器名稱不是 `mysql` 怎麼辦？
A: 修改配置檔案中的 `host` 為實際的容器名稱。

## 快速修復步驟

1. **確認 MySQL 容器運行**
   ```bash
   cd ../laradock
   docker-compose ps mysql
   ```

2. **修改配置檔案**
   編輯 `common/config/main-local.php`，將：
   ```php
   'dsn' => 'mysql:host=127.0.0.1;dbname=ball_lionstlu',
   ```
   改為：
   ```php
   'dsn' => 'mysql:host=mysql;dbname=ball_lionstlu',
   ```

3. **重新載入頁面測試**

## 其他可能的原因

如果修改後仍有問題，檢查：

1. **MySQL 容器是否正常啟動**
   ```bash
   docker-compose logs mysql
   ```

2. **資料庫是否存在**
   ```bash
   docker-compose exec mysql mysql -u root -p -e "SHOW DATABASES;"
   ```

3. **使用者權限**
   ```bash
   docker-compose exec mysql mysql -u root -p -e "SELECT User, Host FROM mysql.user WHERE User='ball';"
   ```

4. **防火牆或網路設定**
   確認 Laradock 的 Docker 網路設定正確。

